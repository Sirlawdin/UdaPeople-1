---
- name : "show remote env"
  shell : env

- name: Create directory
  file:
    path: ~/udaappdir
    state: directory
    mode: 0755

- name: Upload artifact
  copy:
    src: files/dist.zip
    dest: ~/udaappdir

# Extract the zipped artifact into the EC2 instance, and then start the app.
- name: extract
  shell: |
    cd ~/udaappdir
    unzip ~/udaappdir/dist.zip
    npm i


- name: Start the app
  become: yes
  shell: pm2 start ./main.js -f
  environment:
    TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION') }}"
    TYPEORM_MIGRATIONS_DIR: "./migrations"
    TYPEORM_MIGRATIONS: "./migrations/*.js"
    TYPEORM_ENTITIES: "./modules/domain/**/*.entity.js"
    TYPEORM_HOST: "{{ lookup('env', 'TYPEORM_HOST') }}"
    TYPEORM_PORT: "{{ lookup('env', 'TYPEORM_PORT') }}"
    TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME') }}"
    TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD') }}"
    TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE') }}"